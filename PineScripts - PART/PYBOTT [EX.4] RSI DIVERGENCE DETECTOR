// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© PuttipongAutomateTrader

//@version=4

//strategy("PYBOTT [EX.4] - RSI DIVERGENCE DETECTOR", shorttitle = " PYBOTT [EX.4] - RSI DIVERGENCE DETECTOR", overlay=true,default_qty_type=strategy.cash, currency=currency.USD,initial_capital=1000,commission_type =strategy.commission.percent,commission_value=0.1)
study("PYBOTT [EX.4] - RSI DIVERGENCE DETECTOR", shorttitle = " PYBOTT [EX.4] - RSI DIVERGENCE DETECTOR", overlay=true)
// DEFINE VARIABLE
RSI_LOOKBACK = input(defval=20,minval=5,title="RSI_LOOKBACK")
RSI_CURRENT_LOOKBACK = input(defval=1,minval=1,title="RSI_CURRENT_LOOKBACK")
RSI_MULTIPLIED_LOOKBACK = input(defval=3,minval=1,title="RSI_MULTIPLIED_LOOKBACK")

// 1. CREATE RSI , SMOOTH RSI , EMA200
RSI_LEN = input(14, minval=1, title="RSI_Length")
up = rma(max(change(close), 0), RSI_LEN)
down = rma(-min(change(close), 0), RSI_LEN)

FILTER_EMA200 = input( defval=false , title = "FILTER EMA200" )
EMA200 = ema(close,200)
RSI = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))

plot(EMA200,"EMA200")
plotchar(RSI,"RSI")

// 2. CREATE VARIABLE DEFINE RSI 
RSI_LOOKBACK_INDEX_LOW = 0
RSI_LOOKBACK_INDEX_HIGH = 0

CURRENT_RSI = RSI
PREVIOUS_RSI = RSI[RSI_CURRENT_LOOKBACK] // close[index] 
DECTECT_LAST_RSI = RSI[RSI_CURRENT_LOOKBACK*RSI_MULTIPLIED_LOOKBACK]
LOWWEST_RSI = lowest(DECTECT_LAST_RSI,RSI_LOOKBACK) // get lowest bar
HIGHEST_RSI = highest(DECTECT_LAST_RSI,RSI_LOOKBACK) // get highest bar

RSI_LOOKBACK_INDEX_LOW := barssince(DECTECT_LAST_RSI == LOWWEST_RSI) + RSI_CURRENT_LOOKBACK*RSI_MULTIPLIED_LOOKBACK // update bar index
RSI_LOOKBACK_INDEX_HIGH := barssince(DECTECT_LAST_RSI == HIGHEST_RSI) + RSI_CURRENT_LOOKBACK*RSI_MULTIPLIED_LOOKBACK // update bar index

plotchar( CURRENT_RSI , "CURRENT_RSI" )
plotchar( PREVIOUS_RSI , "PREVIOUS_RSI" )
plotchar( DECTECT_LAST_RSI , "DECTECT_LAST_RSI" )
plotchar( LOWWEST_RSI , "LOWWEST_RSI" )
plotchar( HIGHEST_RSI , "HIGHEST_RSI" )
plotchar( RSI_LOOKBACK_INDEX_LOW , "RSI_LOOKBACK_INDEX_LOW" )
plotchar( RSI_LOOKBACK_INDEX_HIGH , "RSI_LOOKBACK_INDEX_HIGH" )
// 3. CREATE VARIABLE DEFINE PRICE
CURRENT_PRICE = close
PREVIOUS_PRICE = close[RSI_CURRENT_LOOKBACK]
PRICE_AT_RSI_LOOKBACK_LOW = close[RSI_LOOKBACK_INDEX_LOW]
PRICE_AT_RSI_LOOKBACK_HIGH = close[RSI_LOOKBACK_INDEX_HIGH]

plotchar( CURRENT_PRICE , "CURRENT_PRICE" )
plotchar( PREVIOUS_PRICE , "PREVIOUS_PRICE" )
plotchar( PRICE_AT_RSI_LOOKBACK_LOW , "PRICE_AT_RSI_LOOKBACK_LOW" )
plotchar( PRICE_AT_RSI_LOOKBACK_HIGH , "PRICE_AT_RSI_LOOKBACK_HIGH" )

// 4. SIGNALS CONDITIONS
IS_EMA200 = 0
CHECK_RSI = 0
CHECK_PRICE = 0

    // FOR LONG POSITION
if(close > EMA200) // EMA200
    IS_EMA200 := 1
if(CURRENT_RSI > PREVIOUS_RSI and PREVIOUS_RSI > LOWWEST_RSI) // EMA200
    CHECK_RSI := 1
if(CURRENT_PRICE > PREVIOUS_PRICE and PREVIOUS_PRICE < PRICE_AT_RSI_LOOKBACK_LOW )
    CHECK_PRICE := 1
    
    // FOR SHORT POSITION
if(close < EMA200)
    IS_EMA200 := 2
if(CURRENT_RSI < PREVIOUS_RSI and PREVIOUS_RSI < HIGHEST_RSI)
    CHECK_RSI := 2
if(CURRENT_PRICE < PREVIOUS_PRICE and PREVIOUS_PRICE > PRICE_AT_RSI_LOOKBACK_HIGH )
    CHECK_PRICE := 2


// CREATE ALERT
CHECK_SHORT = false
CHECK_LONG = false

if (FILTER_EMA200)
    CHECK_SHORT := IS_EMA200 == 2 and CHECK_RSI== 2 and CHECK_PRICE == 2
    CHECK_LONG := IS_EMA200 == 1 and CHECK_RSI== 1 and CHECK_PRICE == 1
else

    CHECK_SHORT := CHECK_RSI== 2 and CHECK_PRICE == 2
    CHECK_LONG := CHECK_RSI== 1 and CHECK_PRICE == 1

plotshape( CHECK_SHORT , title = "CHECK_SHORT" , style=shape.triangledown , location = location.abovebar , color = color.red ,size = size.small)
plotshape( CHECK_LONG , title = "CHECK_LONG" ,style=shape.triangleup , location = location.belowbar , color = color.green ,size = size.small)
plotchar( IS_EMA200 , "IS_EMA200" )
plotchar( CHECK_RSI , "CHECK_RSI" )
plotchar( CHECK_PRICE , "CHECK_PRICE" )

//if (CHECK_LONG)
    //alert( message = "IS_EMA200 : " + IS_EMA200 + " \n CHECK_RSI : " + CHECK_RSI + "\n CHECK_PRICE : " + CHECK_PRICE , freq = alert.freq_once_per_bar_close )


//PYBOTT [EX.4] - RSI DIVERGENCE DETECTOR 
//INPUT : 
//1. RSI LOOKBACK
//2. RSI CURRENT LOOKBACK

//VARIABLE (USE BARSINCE)
//A. RSI LOOKBACK INDEX
//B. RSI CURRENT LOOKBACK INDEX

//1. CREATE RSI , SMOOTH RSI , EMA200
//2. CREATE VARIABLE DEFINE RSI 
//	A. CURRENT RSI
//	B. PREVIOUS RSI [RSI CURRENT LOOKBACK]
//	C. LOWWEST RSI [RSI LOOKBACK] , HIGHEST RSI [RSI LOOKBACK]
//	D. USE BARSINCE FUNCTION TO GET INDEX
//  E. UPDATE INDEX TO VARIABLE [RSI CURRENT LOOKBACK] , [RSI LOOKBACK]

//3. CREATE VARIABLE DEFINE PRICE
//	A. CURRENT PRICE
//	B. GET INDEX FROM VARIABLE
//	C. PREVIOUS PRICE [PRICE CURRENT LOOKBACK]
//  E. LOWWEST PRICE [PRICE LOOKBACK] , HIGHEST PRICE [PRICE LOOKBACK]

//4. SIGNALS CONDITIONS
//	A. FOR LONG POSITION
//		A0. EMA200 IS ABOVE
//		A1. CHECK RSI : CURRENT RSI > PREVIOUS RSI [RSI CURRENT LOOKBACK] AND PREVIOUS RSI [RSI CURRENT LOOKBACK] > LOWWEST RSI [RSI LOOKBACK]
//		A2. CHECK PRICE : CURRENT PRICE > PREVIOUS PRICE [RSI CURRENT LOOKBACK] AND PREVIOUS PRICE [RSI CURRENT LOOKBACK] < PREVIOUS PRICE [RSI CURRENT]
//
//	B. FOR SHORT POSITION
//		A0. EMA200 IS BELOW
//		B1. CURRENT RSI < PREVIOUS RSI [RSI CURRENT LOOKBACK] AND PREVIOUS RSI [RSI CURRENT LOOKBACK] < HIGHEST RSI [RSI LOOKBACK]
//		B2. CHECK PRICE : CURRENT PRICE < PREVIOUS PRICE [RSI CURRENT LOOKBACK] AND PREVIOUS PRICE [RSI CURRENT LOOKBACK] > PREVIOUS PRICE [RSI CURRENT]
//
//5. CALCULATION POSITION SIZE , TP , SL
//	A. GET PRICE AT [RSI CURRENT LOOKBACK]
//	B. TAKEPROFITS AT OPPOSITE RSI DIVERGENCE 


    
